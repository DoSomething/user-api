box: dosomething/ds-docker-php:7.2

services:
  - redis

build:
  # The steps that will be executed on build
  steps:
    - script:
        name: start mongodb
        code: |-
          sudo /usr/bin/mongod --quiet --config /etc/mongod.conf --fork --logpath /var/log/mongod.log
    - leipert/composer-install@0.9.1
    - npm-install
    - script:
        name: build front-end assets
        code: npm run build
    - script:
        name: phpunit
        code: |-
          php artisan northstar:setup
          export REDIS_HOST=$REDIS_PORT_6379_TCP_ADDR
          export REDIS_PORT=$REDIS_PORT_6379_TCP_PORT
          vendor/bin/phpunit
    - script:
        name: prepare for production
        code: |-
          rm -rf storage/cache # clear cached test keys
          rm .env # reset APP_ENV=production
          composer install --no-dev # remove dev dependencies
          php artisan package:discover # discover packages
